const help = require('./commands/help')

async function msgHandler (client, message) {
        try {
            const { type, id, from, t, sender, isGroupMsg, chat, caption, isMedia, mimetype, quotedMsg, mentionedJidList } = message
            let { body } = message
            const { name } = chat
            let { pushname, verifiedName } = sender
            pushname = pushname || verifiedName // verifiedName is the name of someone who uses a business account
            const prefix = '#'
            body = (type === 'chat' && body.startsWith(prefix)) ? body : ((type === 'image' && caption) && caption.startsWith(prefix)) ? caption : ''
            const command = body.slice(prefix.length).trim().split(/ +/).shift().toLowerCase()
            const args = body.slice(prefix.length).trim().split(/ +/).slice(1)
            const isCmd = body.startsWith(prefix)
            const time = moment(t * 1000).format('DD/MM HH:mm:ss')
            if (!isCmd && !isGroupMsg) return console.log('[RECV]', color(time, 'yellow'), 'Message from', color(pushname))
            if (!isCmd && isGroupMsg) return console.log('[RECV]', color(time, 'yellow'), 'Message from', color(pushname), 'in', color(name))
            if (isCmd && !isGroupMsg) console.log(color('[EXEC]'), color(time, 'yellow'), color(`${command} [${args.length}]`), 'from', color(pushname))
            if (isCmd && isGroupMsg) console.log(color('[EXEC]'), color(time, 'yellow'), color(`${command} [${args.length}]`), 'from', color(pushname), 'in', color(name))

            const botNumber = await client.getHostNumber()
            const groupId = isGroupMsg ? chat.groupMetadata.id : ''
            const groupAdmins = isGroupMsg ? await client.getGroupAdmins(groupId) : ''
            const groupMembers = isGroupMsg ? await client.getGroupMembersId(groupId) : ''
            const isGroupAdmins = isGroupMsg ? groupAdmins.includes(sender.id) : false
            const isBotGroupAdmins = isGroupMsg ? groupAdmins.includes(botNumber + '@c.us') : false

            const url = args.length !== 0 ? args[0] : ''

            switch (command) {
            case 'menu':
            case 'help': {
                help(client, from)
                break
            }

                // TODO ADD MORE COMMANDS HERE

            default:
                console.log(color('[ERROR]', 'red'), color(time, 'yellow'), 'Unregistered Command from', color(pushname))
                break
            }
        } catch (err) {
            console.log(color('[ERROR]', 'red'), err)
        }
    }
